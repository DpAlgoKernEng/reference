# 注释（Comments）

## 1. 概述（Overview）

**注释（Comments）** 是程序代码中的内嵌文档形式。当注释被插入到程序中时，编译器会将其忽略；注释的唯一目的是为阅读源代码的人类提供说明性笔记。

虽然特定文档格式不属于 C++ 标准，但存在多种工具可以解析不同格式的注释文档（如 Doxygen、Qt Documentation 等）。

C++ 支持两种注释语法：
- **C 风格注释**：`/* comment */`，也称为多行注释
- **C++ 风格注释**：`// comment`，也称为单行注释

所有注释在**翻译阶段 3（translation phase 3）** 被移除，每个注释被替换为单个空白字符。

## 2. 来源与演变（Origin and Evolution）

### 历史背景

| 标准 | 说明 |
|------|------|
| C++98 | 同时支持 C 风格和 C++ 风格注释 |
| C++11 | 沿用既有注释规范 |
| C++17 | 沿用既有注释规范 |
| C++20 | 沿用既有注释规范 |

### 设计动机

- **C 风格注释**：继承自 C 语言，适用于注释大段文本或代码块
- **C++ 风格注释**：C++ 语言原生引入，提供更便捷的单行注释方式，后又被 C99 标准采纳

### 与 C 语言的关系

C++ 从诞生之初就支持两种注释风格，而 C 语言直到 C99 标准才引入 `//` 注释。这体现了 C++ 在设计时对开发者体验的重视。

## 3. 语法与参数（Syntax and Parameters）

### C 风格注释（多行注释）

```
/* comment */
```

- 以 `/*` 开始，以 `*/` 结束
- 可以跨越多行
- **不支持嵌套**

### C++ 风格注释（单行注释）

```
// comment
```

- 以 `//` 开始，到换行符结束
- 仅作用于单行
- 可连续使用形成多行注释效果

### 语法规则

| 注释类型 | 起始符 | 终止符 | 嵌套支持 |
|----------|--------|--------|----------|
| C 风格 | `/*` | `*/` | 不支持 |
| C++ 风格 | `//` | 换行符 | 可嵌套 C 风格注释 |

**重要约束**：
- 注释不能出现在字符常量、字符串字面量或其他注释内部
- C 风格注释的内容仅被扫描以识别终止符 `*/`
- C++ 风格注释的内容仅被扫描以识别终止换行符

## 4. 底层原理（Underlying Principles）

### 编译处理阶段

注释在编译的**翻译阶段 3** 被处理：

```
源代码 → [阶段1-2] → [阶段3: 注释替换为空格] → [阶段4-7: 预处理/编译] → 目标代码
```

### 预处理器与注释

由于注释在预处理阶段之前被移除，以下机制无法实现：

```cpp
/* 尝试用宏形成注释 - 无效 */
#ifndef DEBUG
    #define LOG //
#else
    #define LOG std::cout
#endif
LOG << "Debug message\n";  // "//" 被替换为空格，而非形成注释
```

### 文件包含与注释

未终止的 C 风格注释不会跨越 `#include` 文件边界：

```cpp
/* file1.h 中未闭合的注释
#include "file2.h"  /* file2.h 的内容不受 file1.h 注释影响 */
```

### 注释与宏定义

注释在宏定义中同样会被移除：

```cpp
#define ABC 1//2134
// ABC 展开为 "1"，而非 "1//2134"
// 因为 "//2134" 在预处理前已被作为注释移除
```

## 5. 使用场景（Use Cases）

### 适用场景

| 场景 | 推荐注释类型 | 示例 |
|------|--------------|------|
| 文件头说明 | C 风格 | `/* 文件描述 */` |
| 文档注释（Doxygen） | C 风格 | `/** @brief 说明 */` |
| 单行代码说明 | C++ 风格 | `// 说明` |
| 临时禁用代码 | C 风格或 `#if 0` | `/* code */` |
| 调试标记 | C++ 风格 | `// TODO: fix` |

### 文档块约定

虽然不属于 C++ 标准，但 `/** ... */` 常用于标记文档块，配合 Doxygen 等工具自动生成 API 文档：

```cpp
/**
 * @brief 计算两个数的和
 * @param a 第一个操作数
 * @param b 第二个操作数
 * @return 两数之和
 */
int add(int a, int b);
```

### 代码排除机制对比

| 方法 | 优点 | 缺点 |
|------|------|------|
| `/* ... */` | 简单直接 | 不支持嵌套 |
| `// ...` | 每行注释 | 多行操作繁琐 |
| `#if 0 ... #endif` | 支持嵌套、可条件编译 | 语法稍复杂 |
| `if (false) { ... }` | 代码仍会被编译检查 | 可能产生编译警告 |

### 常见陷阱

1. **C 风格注释不支持嵌套**：

```cpp
/*
    外层注释开始
    /* 内层注释 - 错误！ */
    这里已经不是注释了！
*/
```

2. **注释内部意外的终止符**：

```cpp
/* 初始化变量 x = y * z; 此处的 */ 会意外终止注释 */
```

3. **宏定义中的注释**：

```cpp
#define MAX(a, b) ((a) > (b) ? (a) : (b)) // 返回较大值
// 注释不会成为宏的一部分，在宏展开时已被移除
```

## 6. 代码示例（Examples）

### 基础用法

```cpp
#include <iostream>

/* C 风格注释可以包含
   多行内容 */
/* 或者仅注释一行 */

/**************
 *  可以插入任意数量的 *，但
 *  不能嵌套注释
 */

// C++ 风格注释可注释单行

// 或者，
// 可以连续使用

int main()
{
    // 注释在预处理前被移除，
    // 所以 ABC 是 "1"，而非 "1//2134"
    // 输出 "1 hello world"
#define ABC 1//2134
    std::cout << ABC << " hello world\n";

    // 以下代码不会执行
    // return 1;

    // 以下代码会执行
    return 0;
}
```

**输出**：
```
1 hello world
```

### 注释嵌套的正确方式

```cpp
// C++ 风格注释中可包含 C 风格注释
// y = f(x);   /* invoke algorithm */

/* C 风格注释中可包含 C++ 风格注释 */
/*
    y = f(x);   // invoke algorithms
    z = g(x);
*/
```

### 代码排除的最佳实践

```cpp
/* 使用 #if 0 排除代码块（推荐用于大段代码） */
#if 0
    std::cout << "这段代码不会被编译或执行\n";
    /* 无 C 风格注释冲突 */
    // 无 C++ 风格注释冲突
#endif

/* 使用 if (false) 排除代码（代码仍会被编译检查语法） */
if (false)
{
    std::cout << "这段代码会被编译但不会执行\n";
}
```

### 常见错误及修正

```cpp
/* 错误：尝试嵌套 C 风格注释 */
/*
    int x = 10;
    /* 设置默认值 */
    int y = 20;
*/
/* 编译错误：第一个 */ 匹配了第一个 /*，后续代码暴露 */

/* 正确做法：使用 C++ 风格注释作为内部注释 */
/*
    int x = 10;
    // 设置默认值
    int y = 20;
*/
```

```cpp
/* 错误：字符串中的注释符号 */
const char* str = "/* 这不是注释 */";  // 正确：注释不作用于字符串内部

/* 错误：误以为宏可以创建注释 */
#define BEGIN_COMMENT /*
#define END_COMMENT */
BEGIN_COMMENT 这不会被注释 END_COMMENT  // 宏展开后不会形成注释

/* 正确理解：注释在预处理前已被移除 */
```

## 7. 总结（Summary）

### 核心要点

1. **两种语法**：C 风格 `/* */` 和 C++ 风格 `//`
2. **处理时机**：翻译阶段 3，预处理之前
3. **替换规则**：每个注释替换为单个空白字符
4. **嵌套限制**：C 风格注释不支持嵌套

### 技术对比

| 特性 | C 风格注释 | C++ 风格注释 |
|------|------------|--------------|
| 标准支持 | C++98 起 | C++98 起 |
| 跨行 | 支持 | 需连续使用 |
| 嵌套 | 不支持 | 可含 C 风格 |
| 常用场景 | 文档块、大段代码排除 | 单行说明、行尾注释 |

### 与 C 语言注释的对比

| 特性 | C++ | C |
|------|-----|---|
| C 风格注释 `/* */` | C++98 起 | C89 起 |
| C++ 风格注释 `//` | C++98 起 | C99 起 |
| 文档工具支持 | Doxygen 等 | Doxygen 等 |

### 最佳实践

- 使用 `/** ... */` 标记文档块（配合 Doxygen）
- 使用 `//` 进行单行注释
- 大段代码排除使用 `#if 0 ... #endif`
- 避免在 C 风格注释内部使用 `*/`
- 注意注释在宏定义中的行为

### 参考资料

- C++98 标准 (ISO/IEC 14882:1998): 2.7 Comments
- C++11 标准 (ISO/IEC 14882:2011): 2.7 Comments
- C++17 标准 (ISO/IEC 14882:2017): 5.7 Comments
- C++20 标准 (ISO/IEC 14882:2020): 5.7 Comments