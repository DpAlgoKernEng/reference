# 注释（Comments）

## 1. 概述（Overview）

**注释（Comments）** 是程序代码中的内嵌文档形式。当注释被插入到程序中时，编译器会将其忽略；注释的唯一目的是为阅读源代码的人类提供说明性笔记。

C 语言支持两种注释语法：
- **C 风格注释**：`/* comment */`，也称为多行注释
- **C++ 风格注释**：`// comment`，也称为单行注释（自 C99 起支持）

所有注释在**翻译阶段 3（translation phase 3）** 被移除，每个注释被替换为单个空白字符。

## 2. 来源与演变（Origin and Evolution）

### 历史背景

| 标准 | 说明 |
|------|------|
| C89/C90 | 仅支持 C 风格注释 `/* */` |
| C99 | 引入 C++ 风格注释 `//`，与 C++ 保持一致 |
| C11 | 沿用 C99 的注释规范 |
| C17 | 沿用既有注释规范 |

### 设计动机

C 风格注释源自早期的 B 语言和 BCPL 语言，设计用于注释大段文本或代码块。C++ 风格注释则源自 C++ 语言，提供了更便捷的单行注释方式，C99 标准将其引入 C 语言以增强代码可读性和与 C++ 的兼容性。

### 破坏性变更

C99 引入 `//` 注释在某些罕见情况下构成破坏性变更：

```c
a = b //*divisor:*/ c
+ d; /* C89 编译为 a = b / c + d;
        C99 编译为 a = b + d; */
```

这是因为 C89 将 `//` 视为两个普通字符，而 C99 将其视为注释起始符。

## 3. 语法与参数（Syntax and Parameters）

### C 风格注释（多行注释）

```
/* comment */
```

- 以 `/*` 开始，以 `*/` 结束
- 可以跨越多行
- **不支持嵌套**

### C++ 风格注释（单行注释）

```
// comment
```
（自 C99 起）

- 以 `//` 开始，到换行符结束
- 仅作用于单行
- 可连续使用形成多行注释效果

### 语法规则

| 注释类型 | 起始符 | 终止符 | 嵌套支持 |
|----------|--------|--------|----------|
| C 风格 | `/*` | `*/` | 不支持 |
| C++ 风格 | `//` | 换行符 | 可嵌套 C 风格注释 |

**重要约束**：
- 注释不能出现在字符常量、字符串字面量或其他注释内部
- C 风格注释的内容仅被扫描以识别多字节字符和终止符 `*/`
- C++ 风格注释的内容仅被扫描以识别多字节字符和终止换行符

## 4. 底层原理（Underlying Principles）

### 编译处理阶段

注释在编译的**翻译阶段 3** 被处理：

```
源代码 → [阶段1-2] → [阶段3: 注释替换为空格] → [阶段4-7: 预处理/编译] → 目标代码
```

### 预处理器与注释

由于注释在预处理阶段之前被移除，以下机制无法实现：

```c
/* 尝试用宏形成注释 */
#ifndef DEBUG
    #define PRINTF //
#else
    #define PRINTF printf
#endif
PRINTF("Error in file %s at line %i\n", __FILE__, __LINE__);
/* 结果："//" 被替换为空格，而非形成注释 */
```

### 文件包含与注释

未终止的 C 风格注释不会跨越 `#include` 文件边界：

```c
/* file1.h 中未闭合的注释
#include "file2.h"  /* file2.h 的内容不受 file1.h 注释影响 */
```

### 反斜杠续行

反斜杠加换行符的处理属于**翻译阶段 2**，早于注释处理（阶段 3），因此：

```c
// 此注释会延续到下一行 \
puts("这行不会执行"); // 可能产生"多行注释"警告
```

## 5. 使用场景（Use Cases）

### 适用场景

| 场景 | 推荐注释类型 | 示例 |
|------|--------------|------|
| 文件头说明 | C 风格 | `/* 文件描述 */` |
| 函数说明文档 | C 风格 | `/** 文档块 */` |
| 单行代码说明 | C++ 风格 | `// 说明` |
| 临时禁用代码 | C 风格或 `#if 0` | `/* code */` |
| 调试标记 | C++ 风格 | `// TODO: fix` |

### 文档块约定

虽然不属于 C 标准，但 `/** ... */` 常用于标记文档块，第二个星号被视为注释内容的一部分：

```c
/**
 * @brief 函数简要说明
 * @param param1 参数1说明
 * @return 返回值说明
 */
int calculate(int param1);
```

### 代码排除机制对比

| 方法 | 优点 | 缺点 |
|------|------|------|
| `/* ... */` | 简单直接 | 不支持嵌套 |
| `// ...` | 每行注释 | 多行操作繁琐 |
| `#if 0 ... #endif` | 支持嵌套、可条件编译 | 语法稍复杂 |
| `if(0) { ... }` | 代码仍会被编译检查 | 会产生编译警告 |

### 常见陷阱

1. **C 风格注释不支持嵌套**：

```c
/*
    外层注释开始
    /* 内层注释 - 错误！ */
    这里已经不是注释了！
*/
```

2. **注释内部意外的终止符**：

```c
/* 初始化变量 x = y * z; 此处的 */ 会意外终止注释 */
```

## 6. 代码示例（Examples）

### 基础用法

```c
#include <stdio.h>

/*
 * C 风格注释可以包含
 * 多行内容。
 */

/* 或者仅注释一行。 */

// C++ 风格注释可注释单行。

// 或者，
// 可以连续使用。

int main(void)
{
    // 以下代码不会执行
    // puts("Hello");

    // 以下代码会执行
    puts("World");

    // 关于反斜杠 + 换行符的注意事项
    // 尽管属于翻译阶段 2（注释是阶段 3），
    // '\' 仍然决定了源代码哪部分被视为注释：
    // 此注释会延续到下一行 \
    puts("不会执行"); // 可能产生"多行注释"警告
    puts("Hello, again");

    return 0;
}
```

**输出**：
```
World
Hello, again
```

### 注释嵌套的正确方式

```c
// C++ 风格注释中可包含 C 风格注释
// y = f(x);   /* invoke algorithm */

/* C 风格注释中可包含 C++ 风格注释 */
/*
    y = f(x);   // invoke algorithms
    z = g(x);
*/
```

### 代码排除的最佳实践

```c
/* 使用 #if 0 排除代码块（推荐） */
#if 0
    puts("这段代码不会被编译");
    /* 无 C 风格注释冲突 */
    // 无 C++ 风格注释冲突
#endif

/* 使用 if(0) 排除代码（代码仍会被编译检查语法） */
if(0) {
    puts("这段代码会被编译但不会执行");
}
```

### 常见错误及修正

```c
/* 错误：尝试嵌套 C 风格注释 */
/*
    int x = 10;
    /* 设置默认值 */
    int y = 20;
*/
/* 编译错误：第一个 */ 匹配了第一个 /*，后续代码暴露 */

/* 正确做法：使用 C++ 风格注释作为内部注释 */
/*
    int x = 10;
    // 设置默认值
    int y = 20;
*/
```

```c
/* 错误：字符串中的注释符号 */
char* str = "/* 这不是注释 */";  // 这是正确的，注释不作用于字符串内部

/* 错误：误以为宏可以创建注释 */
#define BEGIN_COMMENT /*
#define END_COMMENT */
BEGIN_COMMENT 这不会被注释 END_COMMENT  // 宏展开后不会形成注释

/* 正确理解：注释在预处理前已被移除 */
```

## 7. 总结（Summary）

### 核心要点

1. **两种语法**：C 风格 `/* */` 和 C++ 风格 `//`（C99 起）
2. **处理时机**：翻译阶段 3，预处理之前
3. **替换规则**：每个注释替换为单个空白字符
4. **嵌套限制**：C 风格注释不支持嵌套

### 技术对比

| 特性 | C 风格注释 | C++ 风格注释 |
|------|------------|--------------|
| 标准 | C89 起 | C99 起 |
| 跨行 | 支持 | 需连续使用 |
| 嵌套 | 不支持 | 可含 C 风格 |
| 常用场景 | 文档块、大段代码排除 | 单行说明、行尾注释 |

### 最佳实践

- 使用 `/** ... */` 标记文档块
- 使用 `//` 进行单行注释
- 大段代码排除使用 `#if 0 ... #endif`
- 避免在 C 风格注释内部使用 `*/`
- 注意反斜杠续行与注释的交互

### 参考资料

- C17 标准 (ISO/IEC 9899:2018): 6.4.9 Comments (p: 54)
- C11 标准 (ISO/IEC 9899:2011): 6.4.9 Comments (p: 75)
- C99 标准 (ISO/IEC 9899:1999): 6.4.9 Comments (p: 66)
- C89/C90 标准 (ISO/IEC 9899:1990): 3.1.9 Comments